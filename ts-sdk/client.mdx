---
title: "Client Reference"
description: "API reference for @erdoai/server"
---

# Client Reference

The `@erdoai/server` package provides the `ErdoClient` class for invoking Erdo agents from server-side code.

## Installation

```bash
npm install @erdoai/server
```

## ErdoClient

### Constructor

```typescript
import { ErdoClient } from '@erdoai/server';

// Server-side: Use authToken (API key)
const serverClient = new ErdoClient({
  endpoint?: string;   // API endpoint (default: ERDO_ENDPOINT env or https://api.erdo.ai)
  authToken?: string;  // API key (default: ERDO_AUTH_TOKEN env)
});

// Client-side: Use scoped token (created via createToken)
const clientClient = new ErdoClient({
  endpoint: 'https://api.erdo.ai',
  token: scopedToken,  // Scoped token from createToken()
});
```

You must provide either `authToken` or `token`. Use `authToken` for server-side code with full API access, and `token` for client-side code with limited scope.

### createToken()

Create a scoped token for client-side use. Requires `authToken` (API key) authentication.

```typescript
const { token, expiresAt } = await client.createToken(params: CreateTokenParams): Promise<TokenResponse>;
```

**CreateTokenParams:**

```typescript
interface CreateTokenParams {
  botKeys?: string[];           // Bot keys the token can access
  datasetIds?: string[];        // Dataset IDs the token can access
  externalUserId?: string;      // External user ID for RBAC (enables thread access)
  expiresInSeconds?: number;    // Token lifetime (default: 3600)
}
```

**TokenResponse:**

```typescript
interface TokenResponse {
  token: string;      // The scoped token
  expiresAt: string;  // ISO timestamp when token expires
}
```

**Example:**

```typescript
// Server-side: Create a token for the frontend
const serverClient = new ErdoClient({
  authToken: process.env.ERDO_AUTH_TOKEN,
});

const { token, expiresAt } = await serverClient.createToken({
  botKeys: ['my-org.data-analyst'],
  externalUserId: 'user_123',  // Your user's ID
  expiresInSeconds: 3600,
});

// Pass token to frontend for client-side use
```

### invoke()

Invoke an agent and wait for the complete result.

```typescript
const result = await client.invoke(botKey: string, params: InvokeParams): Promise<InvokeResult>;
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `botKey` | `string` | The agent identifier (e.g., `'data-analyst'`) |
| `params` | `InvokeParams` | Invocation parameters |

**InvokeParams:**

```typescript
interface InvokeParams {
  messages?: Message[];              // Messages to send to the agent
  parameters?: Record<string, any>;  // Additional parameters
  datasets?: string[];               // Dataset slugs to include
  mode?: InvocationMode;             // 'live' | 'replay' | 'manual'
}

interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
}
```

**InvokeResult:**

```typescript
interface InvokeResult {
  success: boolean;
  botId?: string;
  invocationId?: string;
  result?: {
    status?: string;
    output?: {
      content?: ContentItem[];
    };
  };
  messages: MessageContent[];
  events: SSEEvent[];
  steps: StepInfo[];
  error?: string;
}
```

**Example:**

```typescript
const result = await client.invoke('data-analyst', {
  messages: [
    { role: 'user', content: 'What were our top 10 products by revenue?' }
  ],
  datasets: ['sales-data'],
});

if (result.success) {
  console.log('Status:', result.result?.status);
  console.log('Content:', result.result?.output?.content);
}
```

### invokeStream()

Invoke an agent and stream results as they arrive.

```typescript
const stream = client.invokeStream(botKey: string, params: InvokeParams): AsyncGenerator<SSEEvent>;
```

**SSEEvent:**

```typescript
interface SSEEvent {
  type?: 'content' | 'status' | 'error' | 'done' | string;
  payload?: any;
  metadata?: {
    user_visibility?: 'visible' | 'hidden';
    content_type?: string;
    ui_content_type?: string;
  };
}
```

**Example:**

```typescript
const events: SSEEvent[] = [];

for await (const event of client.invokeStream('data-analyst', {
  messages: [{ role: 'user', content: 'Analyze trends in our data' }],
})) {
  events.push(event);

  switch (event.type) {
    case 'content':
      // New content item (chart, text, etc.)
      console.log('Content:', event.payload);
      break;
    case 'status':
      // Status update (step started, completed, etc.)
      console.log('Status:', event.payload);
      break;
    case 'error':
      console.error('Error:', event.payload);
      break;
    case 'done':
      console.log('Stream complete');
      break;
  }
}
```

## Thread Methods

Thread methods require token authentication with `externalUserId`. Create a token with `externalUserId` to enable thread access for your users.

### createThread()

Create a new thread for the authenticated user.

```typescript
const thread = await client.createThread(params?: CreateThreadParams): Promise<Thread>;
```

**CreateThreadParams:**

```typescript
interface CreateThreadParams {
  name?: string;           // Optional thread name
  datasetIds?: string[];   // Dataset IDs to associate with the thread
}
```

**Thread:**

```typescript
interface Thread {
  id: string;
  name: string;
  createdAt: string;
  updatedAt: string;
}
```

**Example:**

```typescript
const client = new ErdoClient({
  endpoint: 'https://api.erdo.ai',
  token: scopedToken,  // Token with externalUserId
});

const thread = await client.createThread({ name: 'Support Chat' });
console.log('Created thread:', thread.id);
```

### listThreads()

List all threads for the authenticated user.

```typescript
const { threads } = await client.listThreads(): Promise<ListThreadsResponse>;
```

**Example:**

```typescript
const { threads } = await client.listThreads();
for (const thread of threads) {
  console.log(thread.id, thread.name, thread.createdAt);
}
```

### getThread()

Get a specific thread by ID.

```typescript
const thread = await client.getThread(threadId: string): Promise<Thread>;
```

**Example:**

```typescript
const thread = await client.getThread('thread_abc123');
console.log(thread.name, thread.updatedAt);
```

### sendMessage()

Send a message to a thread and stream the bot response.

```typescript
const stream = client.sendMessage(threadId: string, params: SendMessageParams): AsyncGenerator<SSEEvent>;
```

**SendMessageParams:**

```typescript
interface SendMessageParams {
  content: string;    // The message content
  botKey?: string;    // Optional bot to use (uses thread's default if not specified)
}
```

**Example:**

```typescript
for await (const event of client.sendMessage(threadId, {
  content: 'What insights can you find in my data?',
  botKey: 'my-org.data-analyst',
})) {
  switch (event.type) {
    case 'content':
      console.log('Content:', event.payload);
      break;
    case 'status':
      console.log('Status:', event.payload);
      break;
    case 'done':
      console.log('Stream complete');
      break;
  }
}
```

### sendMessageAndWait()

Send a message and wait for the complete response (non-streaming).

```typescript
const events = await client.sendMessageAndWait(threadId: string, params: SendMessageParams): Promise<SSEEvent[]>;
```

**Example:**

```typescript
const events = await client.sendMessageAndWait(threadId, {
  content: 'Summarize recent trends',
});
console.log('Received', events.length, 'events');
```

## Content Types

Agents can return various content types:

| Type | Description |
|------|-------------|
| `text` | Plain text response |
| `json` | Structured JSON data |
| `markdown` | Formatted markdown text |
| `chart` | Chart configuration with data |
| `table` | Tabular data |
| `code` | Code snippets |

**ContentItem:**

```typescript
interface ContentItem {
  content_type: 'text' | 'json' | 'code' | 'table' | 'image' | 'error';
  ui_content_type?: 'chart' | 'bar_chart' | 'line_chart' | 'pie_chart' | 'table' | 'markdown';
  content?: string;
  data?: any;
}
```

## Error Handling

```typescript
try {
  const result = await client.invoke('data-analyst', {
    messages: [{ role: 'user', content: 'Analyze data' }],
  });

  if (!result.success) {
    console.error('Invocation failed:', result.error);
  }
} catch (error) {
  // Network errors, auth errors, etc.
  console.error('Request failed:', error);
}
```

## Node.js Example

```typescript
import { ErdoClient } from '@erdoai/server';

async function main() {
  const client = new ErdoClient({
    authToken: process.env.ERDO_API_KEY,
  });

  console.log('Invoking agent...');

  for await (const event of client.invokeStream('data-analyst', {
    messages: [{ role: 'user', content: 'What insights can you find?' }],
  })) {
    if (event.type === 'content') {
      console.log('Received:', event.payload?.content_type);
    }
  }
}

main();
```

## B2B Integration Example

For B2B applications where your customers' users need to interact with Erdo agents, use scoped tokens to provide secure, limited access.

### Server-side: Create Token for User

```typescript
// api/authorize/route.ts (Next.js API route)
import { ErdoClient } from '@erdoai/server';

export async function POST(request: Request) {
  const { userId } = await request.json();

  // Your own authorization logic here
  // e.g., check if userId belongs to authenticated session

  const serverClient = new ErdoClient({
    authToken: process.env.ERDO_AUTH_TOKEN,
  });

  const { token, expiresAt } = await serverClient.createToken({
    botKeys: ['my-org.data-analyst'],
    externalUserId: userId,  // Links token to your user
    expiresInSeconds: 3600,
  });

  return Response.json({ token, expiresAt });
}
```

### Client-side: Use Token for Threads

```typescript
// Get token from your server
const { token } = await fetch('/api/authorize', {
  method: 'POST',
  body: JSON.stringify({ userId: currentUser.id }),
}).then(r => r.json());

// Create client with scoped token
const client = new ErdoClient({
  endpoint: 'https://api.erdo.ai',
  token,
});

// Create a thread for the user
const thread = await client.createThread({ name: 'Data Analysis' });

// Send messages and stream responses
for await (const event of client.sendMessage(thread.id, {
  content: 'What were our top products last quarter?',
  botKey: 'my-org.data-analyst',
})) {
  if (event.type === 'content') {
    // Render content to UI
    console.log(event.payload);
  }
}

// Later: List user's threads
const { threads } = await client.listThreads();
```
